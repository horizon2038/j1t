#include <array>
#include <iostream>
#include <pthread.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <type_traits>

using twice = int (*)(int);

// jit hal (pre-code-gen)
class buffer_controller
{
  public:
    virtual auto allocate(uintmax_t byte_width, uintmax_t size) -> void * = 0;
    virtual auto deallocate(void *buffer, uintmax_t size) -> void         = 0;
};

class macos_buffer_controller : public buffer_controller
{
  public:
    auto allocate(uintmax_t byte_width, uintmax_t size) -> void * override
    {
        const auto protect_flag = PROT_READ | PROT_WRITE | PROT_EXEC;
        const auto flags        = MAP_ANON | MAP_PRIVATE | MAP_JIT;
        void *buffer = mmap(NULL, byte_width * size, protect_flag, flags, -1, 0);

        return buffer;
    }

    auto deallocate(void *buffer, uintmax_t size) -> void override
    {
        munmap(buffer, size);
    }
};

// pseudo code
// 1. allocate executable memory
// 2. write machine instructions to the memory
//   0. (pre-code-gen) architecture-specific configuration (e.g., macos
//   pthread_jit_write_protect_np)
//   1. make prologue
//   2. make body
//   3. make epilogue
//   4. (post-code-gen) architecture-specific finalization
// 3. cast the memory to function pointer
// 4. call the function

auto main() -> int
{
    const uintmax_t code_size = 2;

    macos_buffer_controller controller;

    int *instrs = static_cast<int *>(controller.allocate(sizeof(int), code_size));

    // macos
    pthread_jit_write_protect_np(false);

    instrs[0] = 0x8b000000;
    instrs[1] = 0xd65f03c0;

    pthread_jit_write_protect_np(true);

    twice func = reinterpret_cast<twice>(instrs);
    printf("2 * 5 = %d\n", func(5));

    controller.deallocate(instrs, sizeof(int) * code_size);

    return 0;
}
